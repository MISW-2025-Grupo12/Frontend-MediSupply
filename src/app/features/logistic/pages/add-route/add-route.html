<div class="page-container" *transloco="let t">
  <div class="page-header">
    <div>
      <h1 class="page-title">{{ t('logistic.actions.createRoute') }}</h1>
      <p class="page-subtitle">
        {{ t('logistic.addRoute.subtitle') }}
      </p>
    </div>

    <a class="page-action-button" routerLink="../">
      {{ t('common.back') }}
    </a>
  </div>

  <div class="page-content">
    <form class="route-form" [formGroup]="routeForm" (ngSubmit)="onSubmit()">
      <mat-card class="route-form-card">
        <mat-card-content>
          <div class="form-grid">
            <mat-form-field class="form-field">
              <mat-label>{{ t('logistic.addRoute.fields.date') }}</mat-label>
              <input matInput [matDatepicker]="routeDatePicker" formControlName="date" />
              <mat-datepicker-toggle matIconSuffix [for]="routeDatePicker"></mat-datepicker-toggle>
              <mat-datepicker #routeDatePicker></mat-datepicker>
            </mat-form-field>

            <mat-form-field class="form-field">
              <mat-label>{{ t('logistic.addRoute.fields.driver') }}</mat-label>
              <input matInput type="text" formControlName="driverId" placeholder="DR-001" />
            </mat-form-field>
          </div>

          <section class="selected-deliveries">
            <header class="selected-deliveries__header">
              <h3 class="selected-deliveries__title">
                {{ t('logistic.addRoute.selectedDeliveries') }}
              </h3>
              <span class="selected-deliveries__count">
                {{ t('logistic.addRoute.selectedCount', { count: selectedDeliveriesCount() }) }}
              </span>
            </header>

            @if (selectedDeliveriesCount()) {
              <div class="selected-deliveries__list" role="list">
                @for (delivery of selectedDeliveries(); track delivery.id) {
                  <article class="selected-deliveries__card" role="listitem">
                    <header class="selected-deliveries__card-header">
                      <span class="selected-deliveries__card-id">
                        {{ delivery.id }}
                      </span>
                      <button
                        type="button"
                        class="selected-deliveries__remove-button"
                        (click)="onDeliveryToggled(delivery)">
                        {{ t('logistic.actions.removeFromRoute') }}
                      </button>
                    </header>

                    <div class="selected-deliveries__card-body">
                      <p class="selected-deliveries__card-row">
                        <span class="selected-deliveries__card-label">
                          {{ t('logistic.unassigned.labels.deliveryAddress') }}
                        </span>
                        <span class="selected-deliveries__card-value">
                          {{ delivery.address }}
                        </span>
                      </p>

                      <p class="selected-deliveries__card-row">
                        <span class="selected-deliveries__card-label">
                          {{ t('logistic.unassigned.labels.deliveryDate') }}
                        </span>
                        <span class="selected-deliveries__card-value">
                          {{ delivery.deliveryDate | date: 'dd MMM yyyy' }}
                        </span>
                      </p>

                      <p class="selected-deliveries__card-row">
                        <span class="selected-deliveries__card-label">
                          {{ t('logistic.unassigned.labels.orderTotal') }}
                        </span>
                        <span class="selected-deliveries__card-value">
                          {{ delivery.order.total | currency:'COP':'symbol':'1.0-0' }}
                        </span>
                      </p>

                      <p class="selected-deliveries__card-row">
                        <span class="selected-deliveries__card-label">
                          {{ t('logistic.unassigned.labels.customer') }}
                        </span>
                        <span class="selected-deliveries__card-value">
                          {{ delivery.order.customer.name }}
                        </span>
                      </p>
                    </div>
                  </article>
                }
              </div>
            } @else {
              <p class="selected-deliveries__empty">
                {{ t('logistic.addRoute.noDeliveriesSelected') }}
              </p>
            }
        </section>

        <section class="delivery-map">
          <header class="delivery-map__header">
            <h3 class="delivery-map__title">
              {{ t('logistic.addRoute.map.title') }}
            </h3>
            <p class="delivery-map__description">
              {{ t('logistic.addRoute.map.description') }}
            </p>
          </header>

          <app-maps
            [deliveries]="selectedDeliveries()"
            [ariaLabel]="t('logistic.addRoute.map.title')"
            [loadingMessage]="t('logistic.addRoute.map.loading')"
            [loadErrorMessage]="t('logistic.addRoute.map.loadError')"
            [emptyMessage]="t('logistic.addRoute.map.noDeliveries')"
            [missingKeyMessage]="t('logistic.addRoute.map.missingKey')"
            [routePath]="calculatedRoutePath()"
            [routeOrder]="calculatedRouteOrder()"></app-maps>
        </section>
        </mat-card-content>

        <mat-card-actions class="form-actions">
          <button
            type="button"
            class="page-action-button page-action-button--secondary"
            [disabled]="selectedDeliveriesCount() < 2 || isCalculatingRoutes()"
            (click)="onCalculateRoutes()">
            {{ t('logistic.actions.calculateRoute') }}
          </button>

          <button type="submit" class="page-action-button" [disabled]="routeForm.invalid">
            {{ t('logistic.actions.createRoute') }}
          </button>
        </mat-card-actions>
      </mat-card>
    </form>

    <section class="deliveries-section">
      <header class="deliveries-section__header">
        <h2 class="deliveries-section__title">
          {{ t('logistic.unassigned.sectionTitle') }}
        </h2>
        <p class="deliveries-section__description">
          {{ t('logistic.unassigned.sectionDescription') }}
        </p>
      </header>

      <div class="deliveries-section__body">
        @if (isLoading()) {
          <div class="deliveries-section__state">
            {{ t('logistic.states.loading') }}
          </div>
        } @else if (error()) {
          <div class="deliveries-section__state deliveries-section__state--error">
            {{ t('logistic.states.error') }}
            <span class="deliveries-section__state-message">{{ error() }}</span>
          </div>
        } @else {
          <app-unassigned-deliveries
            [deliveries]="availableDeliveries()"
            [selectable]="true"
            [selectedDeliveryIds]="selectedDeliveryIds()"
            (deliveryToggled)="onDeliveryToggled($event)" />
        }
      </div>
    </section>
  </div>
</div>
