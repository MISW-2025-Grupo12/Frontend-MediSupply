name: CI

on:
  workflow_dispatch:   # Allow manual triggering
  pull_request:
    branches: ["**"]   # evaluate all PRs

jobs:
  policy_checks:
    runs-on: ubuntu-latest
    steps:
      - name: Enforce PR policy
        run: |
          echo "event=${{ github.event_name }}"
          
          # Skip policy checks for manual triggers
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual trigger detected - skipping policy checks."
            exit 0
          fi
          
          echo "base=${{ github.base_ref }} head=${{ github.head_ref }}"

          base="${{ github.base_ref }}"
          head="${{ github.head_ref }}"

          # Allow all PRs to develop
          if [ "$base" = "develop" ]; then
            echo "✅ PR to 'develop' allowed."
            exit 0
          fi

          # Allow only develop -> main
          if [ "$base" = "main" ]; then
            if [ "$head" = "develop" ]; then
              echo "✅ PR from 'develop' → 'main' allowed."
              exit 0
            else
              echo "❌ Only PRs from 'develop' can target 'main'. (head='$head')"
              exit 1
            fi
          fi

          # Everything else OK
          echo "✅ PR policy passed for base='$base'."

  build_and_test:
    needs: policy_checks
    if: needs.policy_checks.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20.19'
          cache: npm
      - name: Install deps
        run: npm ci
      - name: Lint
        run: npm run lint --if-present
      - name: Install Chrome dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
      - name: Test
        run: |
          export CHROME_BIN=/usr/bin/google-chrome
          export CHROME_FLAGS='--no-sandbox --disable-setuid-sandbox --disable-dev-shm-usage'
          npm run test:ci
      - name: Build
        run: npm run build -- --configuration=production
